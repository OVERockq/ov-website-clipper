<!DOCTYPE html>
<html lang="{{ current_lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{{ translations.meta_description }}">
    <meta name="keywords" content="{{ translations.meta_keywords }}">
    <title>{{ translations.title }}</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-YOUR_PUBLISHER_ID"
     crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link rel="alternate" hreflang="ko" href="/?lang=ko" />
    <link rel="alternate" hreflang="en" href="/?lang=en" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#3B82F6', // Blue-500
                            hover: '#2563EB'  // Blue-600
                        },
                        secondary: {
                            DEFAULT: '#6B7280', // Gray-500
                            hover: '#4B5563'  // Gray-600
                        },
                        success: {
                            DEFAULT: '#10B981', // Emerald-500
                            hover: '#059669'  // Emerald-600
                        },
                        danger: {
                            DEFAULT: '#EF4444', // Red-500
                            hover: '#DC2626'  // Red-600
                        },
                        info: {
                            DEFAULT: '#3B82F6', // Blue-500 (Primary와 동일하게 사용 또는 다른 색상 지정)
                            hover: '#2563EB'
                        },
                        light: '#F9FAFB', // Gray-50
                        dark: '#1F2937'  // Gray-800
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* 좀 더 현대적인 폰트 (CDN 추가 필요 시 알려주세요) */
        }
        .step-indicator-line {
            height: 2px;
            flex-grow: 1;
            transition: background-color 0.3s ease-in-out;
        }
        .form-select, .form-input {
            @apply mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm;
        }
        /* 로딩 스피너를 위한 간단한 스타일 */
        .spinner {
            border-top-color: transparent;
            animation: spinner 0.8s linear infinite;
        }
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
        .lang-switcher a {
            @apply px-3 py-1 text-sm rounded-md;
        }
        .lang-switcher a.active {
            @apply bg-primary text-white;
        }
        .lang-switcher a:not(.active) {
            @apply text-gray-600 hover:bg-gray-200;
        }
    </style>
</head>
<body class="bg-gray-100" data-disable-translation="{{ disable_translation }}">
    <div class="flex flex-col md:flex-row justify-center min-h-screen p-4 gap-4">
        <!-- Main Content Area -->
        <div class="bg-white shadow-xl rounded-lg p-6 sm:p-10 w-full md:max-w-3xl order-2 md:order-1">
            <header class="mb-8 sm:mb-10">
                <div class="flex justify-between items-center mb-2">
                    <h1 class="text-3xl sm:text-4xl font-bold text-center text-dark flex-grow">
                        <span class="text-primary">{{ translations.logo_text_part1 }}</span><span class="text-gray-600">{{ translations.logo_text_part2 }}</span> <i class="fas fa-wand-magic-sparkles text-primary"></i>
                    </h1>
                    <div class="lang-switcher flex space-x-1">
                        <a href="/?lang=ko" class="{{ 'active' if current_lang == 'ko' else '' }}">한국어</a>
                        <a href="/?lang=en" class="{{ 'active' if current_lang == 'en' else '' }}">English</a>
                    </div>
                </div>
                <p class="text-center text-secondary text-sm sm:text-base">
                    {{ translations.header_subtitle }}
                </p>
            </header>
            
            <!-- Step Indicator -->
            <div class="flex items-center mb-10">
                <div class="step-item flex-1 flex flex-col items-center" data-step="1">
                    <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center text-lg font-semibold z-10 bg-primary text-white border-2 border-primary transition-all duration-300">1</div>
                    <p class="mt-2 text-xs sm:text-sm font-medium text-primary transition-all duration-300">{{ translations.step1_title }}</p>
                </div>
                <div class="step-indicator-line bg-gray-300 transition-all duration-300"></div>
                <div class="step-item flex-1 flex flex-col items-center" data-step="2">
                    <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center text-lg font-semibold z-10 bg-gray-300 text-gray-600 border-2 border-gray-300 transition-all duration-300">2</div>
                    <p class="mt-2 text-xs sm:text-sm text-gray-500 transition-all duration-300">{{ translations.step2_title }}</p>
                </div>
                <div class="step-indicator-line bg-gray-300 transition-all duration-300"></div>
                <div class="step-item flex-1 flex flex-col items-center" data-step="3">
                    <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center text-lg font-semibold z-10 bg-gray-300 text-gray-600 border-2 border-gray-300 transition-all duration-300">3</div>
                    <p class="mt-2 text-xs sm:text-sm text-gray-500 transition-all duration-300">{{ translations.step3_title }}</p>
                </div>
                <div class="step-indicator-line bg-gray-300 transition-all duration-300"></div>
                <div class="step-item flex-1 flex flex-col items-center" data-step="4">
                    <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center text-lg font-semibold z-10 bg-gray-300 text-gray-600 border-2 border-gray-300 transition-all duration-300">4</div>
                    <p class="mt-2 text-xs sm:text-sm text-gray-500 transition-all duration-300">{{ translations.step4_title }}</p>
                </div>
            </div>

            <form id="convertForm" enctype="multipart/form-data" class="space-y-6">
                <!-- Step 1: URL 입력 -->
                <div class="wizard-step active" data-step="1">
                    <h2 class="text-xl font-semibold text-dark mb-6">Step 1: {{ translations.step1_title }}</h2>
                    <div class="mb-4">
                        <label for="url" class="block text-sm font-medium text-gray-700 mb-1">{{ translations.url_input_label }}</label>
                        <input type="url" class="form-input" id="url" name="url" placeholder="{{ translations.url_input_placeholder }}" required>
                        <p class="mt-1 text-xs text-gray-500">{{ translations.url_input_help }}</p>
                        <div class="text-red-500 text-xs mt-1" data-validate-for="url"></div>
                    </div>
                </div>

                <!-- Step 2: 선택자 입력 -->
                <div class="wizard-step hidden" data-step="2">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6">Step 2: {{ translations.step2_title }}</h2>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">{{ translations.conversion_scope_label }}</label>
                        <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0">
                            <label class="flex items-center p-3 border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer flex-1">
                                <input type="radio" name="conversion_scope" value="single" class="form-radio h-5 w-5 text-primary focus:ring-primary-hover" checked>
                                <span class="ml-3 text-sm font-medium text-gray-700">{{ translations.scope_single_page }}</span>
                            </label>
                            <label class="flex items-center p-3 border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer flex-1">
                                <input type="radio" name="conversion_scope" value="multiple" class="form-radio h-5 w-5 text-primary focus:ring-primary-hover">
                                <span class="ml-3 text-sm font-medium text-gray-700">{{ translations.scope_multiple_pages }}</span>
                            </label>
                        </div>
                    </div>

                    <div id="selectors-section" class="hidden space-y-4 pt-4 border-t border-gray-200">
                        <p class="text-sm text-indigo-600 bg-indigo-50 p-3 rounded-md"><i class="fas fa-info-circle mr-2"></i>{{ translations.selectors_info }}</p>
                        <div class="mb-4">
                            <label for="content_selector" class="block text-sm font-medium text-gray-700 mb-1">{{ translations.content_selector_label }}</label>
                            <input type="text" class="form-input" id="content_selector" name="content_selector" placeholder="{{ translations.content_selector_placeholder }}">
                            <p class="mt-1 text-xs text-gray-500">{{ translations.content_selector_help_intro }} <span class="text-indigo-500">{{ translations.content_selector_help_example | safe }}</span></p>
                            <div class="text-red-500 text-xs mt-1" data-validate-for="content_selector"></div>
                        </div>
                        <div class="mb-4">
                            <label for="menu_selector" class="block text-sm font-medium text-gray-700 mb-1">{{ translations.menu_selector_label }}</label>
                            <input type="text" class="form-input" id="menu_selector" name="menu_selector" placeholder="{{ translations.menu_selector_placeholder }}">
                            <p class="mt-1 text-xs text-gray-500">{{ translations.menu_selector_help_intro }} <span class="text-indigo-500">{{ translations.menu_selector_help_example | safe }}</span></p>
                            <div class="text-red-500 text-xs mt-1" data-validate-for="menu_selector"></div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: 포맷 및 번역 설정 -->
                <div class="wizard-step hidden" data-step="3">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6">Step 3: {{ translations.step3_title }}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="output_format" class="block text-sm font-medium text-gray-700 mb-1">{{ translations.output_format_label }}</label>
                            <select class="form-select" id="output_format" name="output_format" required>
                                <option value="epub">EPUB</option>
                                <option value="markdown">Markdown</option>
                                <option value="doc">Word (DOCX)</option>
                                <option value="pdf">PDF</option>
                            </select>
                        </div>
                        <div>
                            <label for="merge_pages" class="block text-sm font-medium text-gray-700 mb-1">{{ translations.merge_pages_label }}</label>
                            <select class="form-select" id="merge_pages" name="merge_pages">
                                <option value="true">{{ translations.merge_pages_yes }}</option>
                                <option value="false">{{ translations.merge_pages_no }}</option>
                            </select>
                            <p class="mt-1 text-xs text-gray-500">{{ translations.merge_pages_help }}</p>
                        </div>
                    </div>
                    {% if not disable_translation %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label for="translator_type" class="block text-sm font-medium text-gray-700 mb-1">{{ translations.translation_option_label }}</label>
                            <select class="form-select" id="translator_type" name="translator_type" required>
                                <!-- JS로 동적 로드 -->
                            </select>
                        </div>
                        <div>
                            <label for="target_lang" class="block text-sm font-medium text-gray-700 mb-1">{{ translations.translation_language_label }}</label>
                            <select class="form-select" id="target_lang" name="target_lang" disabled>
                                <option value="ko">한국어</option>
                                <option value="en">English</option>
                                <option value="ja">日本語</option>
                                <option value="zh">中文</option>
                            </select>
                        </div>
                    </div>
                    {% endif %}
                    <div class="mb-4">
                        <label for="font_family" class="block text-sm font-medium text-gray-700 mb-1">{{ translations.font_family_label }}</label>
                        <select class="form-select" id="font_family" name="font_family">
                            <option value="Noto Sans KR" selected>Noto Sans KR</option>
                            <option value="Nanum Gothic">나눔고딕</option>
                            <option value="Malgun Gothic">맑은고딕</option>
                            <option value="Apple SD Gothic Neo">Apple SD Gothic Neo</option>
                            <option value="Arial">Arial</option>
                            <option value="Times New Roman">Times New Roman</option>
                        </select>
                    </div>
                </div>

                <!-- Step 4: 변환 및 다운로드 -->
                <div class="wizard-step hidden" data-step="4">
                    <h2 class="text-xl font-semibold text-gray-700 mb-6">{{ translations.confirm_and_convert_title }}</h2>
                    <div id="summary" class="bg-blue-50 p-4 rounded-md mb-6">
                        <p class="text-sm font-medium text-gray-700 mb-2">{{ translations.summary_title }}</p>
                        <ul id="summary-list" class="list-disc list-inside text-sm text-gray-600 space-y-1"></ul>
                    </div>
                    <p class="text-sm text-gray-600 mb-6">{{ translations.summary_help }}</p>
                    
                    <div id="loading-section" class="text-center py-6 hidden">
                        <div class="spinner w-12 h-12 rounded-full border-4 border-primary border-t-transparent mx-auto"></div>
                        <p class="text-gray-600 mt-3">{{ translations.loading_text }}</p>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                            <div id="progress-bar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p id="progress-text" class="text-sm text-gray-500 mt-1">0% (0/0 {{ '페이지' if current_lang == 'ko' else 'pages'}})</p>
                    </div>

                    <div id="download-section" class="text-center py-6 hidden">
                        <i class="fas fa-check-circle text-5xl text-success mb-3"></i>
                        <h4 class="text-lg font-semibold text-gray-700">{{ translations.conversion_complete_title }}</h4>
                        <p class="text-sm text-gray-600 mt-1 mb-4">{{ translations.download_prompt }}</p>
                        <button type="button" id="download-btn" class="w-full sm:w-auto bg-success hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-md shadow-sm transition duration-150 ease-in-out">
                            <i class="fas fa-download mr-2"></i> {{ translations.download_button }}
                        </button>
                    </div>
                    <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative hidden" role="alert">
                        <strong class="font-bold">{{ translations.error_prefix }}</strong>
                        <span class="block sm:inline" id="error-text"></span>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="mt-8 pt-6 border-t border-gray-200 flex justify-between items-center">
                    <button type="button" id="prevBtn" class="bg-secondary hover:bg-secondary-hover text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out hidden">
                        <i class="fas fa-arrow-left mr-2"></i> {{ translations.previous_button }}
                    </button>
                    <button type="button" id="nextBtn" class="bg-primary hover:bg-primary-hover text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out">
                        {{ translations.next_button }} <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                    <button type="submit" id="submitBtn" class="bg-success hover:bg-success-hover text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out hidden">
                        <i class="fas fa-check mr-2"></i> {{ translations.submit_button }}
                    </button>
                </div>
            </form>

            <footer class="mt-8 text-center text-xs text-gray-500">
                <p>{{ translations.footer_copyright | safe }}</p>
                <p class="mt-1">
                    {{ translations.footer_rate_limit_info.replace('{rate_limit_convert_per_minute}', rate_limit_convert_per_minute).replace('{rate_limit_per_hour}', rate_limit_per_hour).replace('{rate_limit_per_day}', rate_limit_per_day) }}
                </p>
            </footer>

            <div class="mt-10 pt-6 border-t border-gray-200">
                <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 rounded-md shadow" role="alert">
                    <div class="flex">
                        <div class="py-1"><i class="fas fa-exclamation-triangle fa-lg mr-3"></i></div>
                        <div>
                            <p class="font-bold">{{ translations.copyright_notice_title }}</p>
                            <p class="text-sm">
                                {{ translations.copyright_notice_text }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="adsense-container mt-10 text-center text-xs text-gray-400">
                {% if ad_client_id_bottom and ad_slot_id_bottom %}
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="{{ ad_client_id_bottom }}"
                     data-ad-slot="{{ ad_slot_id_bottom }}"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
                <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
                {% else %}
                <p>{{ translations.bottom_ad_placeholder }}</p>
                {% endif %}
            </div>
        </div>

        <!-- Right Sidebar Ad Area -->
        <div class="w-full md:w-64 order-1 md:order-2 flex-shrink-0">
            <div class="bg-white shadow-xl rounded-lg p-4 sticky top-4">
                <h3 class="text-lg font-semibold text-gray-700 mb-3 text-center">{{ translations.ads_area_title }}</h3>
                <div class="adsense-right-container text-center text-xs text-gray-400">
                    {% if ad_client_id_right and ad_slot_id_right %}
                    <ins class="adsbygoogle"
                         style="display:block;min-width:120px;max-width:240px;width:100%;height:600px;"
                         data-ad-client="{{ ad_client_id_right }}"
                         data-ad-slot="{{ ad_slot_id_right }}"></ins>
                    <script>
                         (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                    {% else %}
                    <p>{{ translations.right_ad_placeholder }}</p>
                    <p class="text-xs text-gray-400">{{ translations.right_ad_size_info }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_DISABLE_TRANSLATION = document.body.dataset.disableTranslation === 'True';
        const SCRIPT_CURRENT_LANG = "{{ current_lang }}";
        const TRANSLATIONS_JS = JSON.parse('{{ translations | tojson | safe }}');

        let currentStep = 1;
        const totalSteps = 4;
        let downloadUrl = null;
        let downloadFileName = null;

        const form = document.getElementById('convertForm');
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const submitBtn = document.getElementById('submitBtn');
        
        const loadingSection = document.getElementById('loading-section');
        const downloadSection = document.getElementById('download-section');
        const downloadBtn = document.getElementById('download-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressTextElem = document.getElementById('progress-text'); // Renamed for clarity
        
        const errorMessageDiv = document.getElementById('error-message');
        const errorTextSpan = document.getElementById('error-text');
        const summaryList = document.getElementById('summary-list');

        const conversionScopeRadios = document.querySelectorAll('input[name="conversion_scope"]');
        const selectorsSection = document.getElementById('selectors-section');
        const contentSelectorInput = document.getElementById('content_selector');
        const menuSelectorInput = document.getElementById('menu_selector');

        function updateStepIndicator() {
            document.querySelectorAll('.step-item').forEach((item, index) => {
                const step = parseInt(item.dataset.step);
                const circle = item.querySelector('.step-circle');
                const title = item.querySelector('p');
                const line = item.previousElementSibling && item.previousElementSibling.classList.contains('step-indicator-line') ? item.previousElementSibling : null;

                circle.classList.remove('bg-primary', 'text-white', 'border-primary', 'bg-gray-300', 'text-gray-600', 'border-gray-300', 'bg-success', 'border-success');
                title.classList.remove('text-primary', 'text-gray-500', 'font-medium', 'text-success');
                
                if (step < currentStep) { // Completed
                    circle.classList.add('bg-success', 'text-white', 'border-success');
                    title.classList.add('text-success', 'font-medium');
                    if(line) line.classList.remove('bg-gray-300');
                    if(line) line.classList.add('bg-success');
                } else if (step === currentStep) { // Active
                    circle.classList.add('bg-primary', 'text-white', 'border-primary');
                    title.classList.add('text-primary', 'font-medium');
                    if(line) line.classList.remove('bg-gray-300');
                    if(line) line.classList.add('bg-primary');
                } else { // Pending
                    circle.classList.add('bg-gray-300', 'text-gray-600', 'border-gray-300');
                    title.classList.add('text-gray-500');
                    if(line) line.classList.remove('bg-primary', 'bg-success');
                    if(line) line.classList.add('bg-gray-300');
                }
            });
        }

        function showStep(stepNumber) {
            document.querySelectorAll('.wizard-step').forEach(step => step.classList.add('hidden'));
            document.querySelector(`.wizard-step[data-step="${stepNumber}"]`).classList.remove('hidden');
            updateStepIndicator();

            prevBtn.classList.toggle('hidden', stepNumber === 1);
            nextBtn.classList.toggle('hidden', stepNumber === totalSteps);
            submitBtn.classList.toggle('hidden', stepNumber !== totalSteps);
        }

        function validateStep(stepNumber) {
            const currentStepDiv = document.querySelector(`.wizard-step[data-step="${stepNumber}"]`);
            const inputs = currentStepDiv.querySelectorAll('input[required], select[required]');
            let isValid = true;
            
            inputs.forEach(input => {
                const validationMsgDiv = currentStepDiv.querySelector(`[data-validate-for="${input.name}"]`);
                if (stepNumber === 2 && selectorsSection.classList.contains('hidden') && input.closest('#selectors-section')) {
                    input.classList.remove('border-red-500');
                    if(validationMsgDiv) validationMsgDiv.textContent = '';
                    return;
                }

                if (!input.value.trim() && input.required) {
                    input.classList.add('border-red-500');
                    if(validationMsgDiv) validationMsgDiv.textContent = TRANSLATIONS_JS.validate_required;
                    isValid = false;
                } else if (input.type === 'url' && !input.value.match(/^(http|https)?:\/\//i)) {
                    input.classList.add('border-red-500');
                     if(validationMsgDiv) validationMsgDiv.textContent = TRANSLATIONS_JS.validate_url;
                    isValid = false;
                }
                 else {
                    input.classList.remove('border-red-500');
                    if(validationMsgDiv) validationMsgDiv.textContent = '';
                }
            });
            return isValid;
        }
        
        function generateSummary() {
            summaryList.innerHTML = ''; 
            const formData = new FormData(form);
            const summaryData = {
                [TRANSLATIONS_JS.url_input_label]: formData.get("url"),
                [TRANSLATIONS_JS.step2_title]: document.querySelector('input[name="conversion_scope"]:checked').parentElement.textContent.trim(),
                [TRANSLATIONS_JS.output_format_label]: formData.get("output_format").toUpperCase(),
                [TRANSLATIONS_JS.merge_pages_label]: formData.get("merge_pages") === "true" ? TRANSLATIONS_JS.merge_pages_yes : TRANSLATIONS_JS.merge_pages_no,
                [TRANSLATIONS_JS.font_family_label]: document.getElementById('font_family').selectedOptions[0].text
            };

            if (!SCRIPT_DISABLE_TRANSLATION) {
                summaryData[TRANSLATIONS_JS.translation_option_label] = document.getElementById('translator_type').selectedOptions[0].text;
                summaryData[TRANSLATIONS_JS.translation_language_label] = formData.get("translator_type") !== "none" ? document.getElementById('target_lang').selectedOptions[0].text : (SCRIPT_CURRENT_LANG === 'ko' ? "해당 없음" : "N/A");
            }

            if (formData.get("conversion_scope") === "multiple") {
                summaryData[TRANSLATIONS_JS.content_selector_label] = formData.get("content_selector");
                summaryData[TRANSLATIONS_JS.menu_selector_label] = formData.get("menu_selector") || (SCRIPT_CURRENT_LANG === 'ko' ? "입력 안함" : "Not entered");
            }

            for (const [key, value] of Object.entries(summaryData)) {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<span class="font-medium text-gray-900">${key}:</span> ${value}`;
                summaryList.appendChild(listItem);
            }
        }

        nextBtn.addEventListener('click', () => {
            if (validateStep(currentStep)) {
                currentStep++;
                if (currentStep === totalSteps) {
                    generateSummary();
                }
                showStep(currentStep);
            }
        });

        prevBtn.addEventListener('click', () => {
            currentStep--;
            showStep(currentStep);
        });

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!validateStep(currentStep)) return;

            downloadUrl = null;
            downloadFileName = null;
            downloadSection.classList.add('hidden');
            
            loadingSection.classList.remove('hidden');
            errorMessageDiv.classList.add('hidden');
            submitBtn.disabled = true;
            prevBtn.disabled = true;
            
            progressBar.style.width = '0%';
            updateProgressText(0,0,0); // Reset progress text
            
            try {
                const formData = new FormData(form);
                const response = await fetch('/convert', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    downloadUrl = window.URL.createObjectURL(blob);
                    
                    const outputFormat = formData.get('output_format');
                    const mergePages = formData.get('merge_pages') === 'true';
                    const menuSelector = formData.get('menu_selector');

                    let extension = outputFormat;
                    if (outputFormat === 'markdown' && !mergePages && menuSelector ) {
                         extension = 'zip';
                    }
                    downloadFileName = `converted_document.${extension}`;
                    
                    loadingSection.classList.add('hidden');
                    downloadSection.classList.remove('hidden');
                } else {
                    const error = await response.text();
                    errorTextSpan.textContent = error;
                    errorMessageDiv.classList.remove('hidden');
                    loadingSection.classList.add('hidden');
                }
            } catch (error) {
                errorTextSpan.textContent = TRANSLATIONS_JS.error_network_unknown.replace('{message}', error.message);
                errorMessageDiv.classList.remove('hidden');
                loadingSection.classList.add('hidden');
            } finally {
                submitBtn.disabled = false;
                prevBtn.disabled = false;
            }
        });
        
        function downloadFileHandler() {
            if (downloadUrl && downloadFileName) {
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = downloadFileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl); 
                a.remove();
            }
        }
        downloadBtn.addEventListener('click', downloadFileHandler);

        function updateProgressText(current, total, progress) {
            progressTextElem.textContent = TRANSLATIONS_JS.progress_text_template
                .replace('{progress}', progress)
                .replace('{current_page}', current)
                .replace('{total_pages}', total);
        }

        const eventSource = new EventSource('/progress');
        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            progressBar.style.width = `${data.progress}%`;
            updateProgressText(data.current_page, data.total_pages, data.progress);
        };
        eventSource.onerror = function(err) {
            console.error("EventSource failed:", err);
        };

        async function loadTranslators() {
            if (SCRIPT_DISABLE_TRANSLATION) {
                const translatorTypeDiv = document.getElementById('translator_type')?.closest('.grid > div');
                const targetLangDiv = document.getElementById('target_lang')?.closest('.grid > div');
                if (translatorTypeDiv) translatorTypeDiv.style.display = 'none';
                if (targetLangDiv) targetLangDiv.style.display = 'none';
                return;
            }
            try {
            const res = await fetch('/api/available_translators');
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            const translators = await res.json();
            const select = document.getElementById('translator_type');
            select.innerHTML = ''; // Clear existing options
                
            // Add default "Do not translate" option based on current language
            const noneOpt = document.createElement('option');
            noneOpt.value = 'none';
            noneOpt.textContent = SCRIPT_CURRENT_LANG === 'ko' ? '번역하지 않음' : 'Do not translate';
            select.appendChild(noneOpt);

            translators.forEach(opt => {
                    // Skip specific "disabled" none option from backend
                    if (opt.value === 'none' && opt.label.includes('비활성화됨')) return;
                    if (opt.value === 'none' && !opt.label.includes('비활성화됨')) return; // Skip generic none if already added

                    const option = document.createElement('option');
                    option.value = opt.value;
                    // For simplicity, translator names are not translated here. Can be added to TRANSLATIONS_JS if needed.
                    option.textContent = opt.label; 
                    if (opt.disabled) { 
                        option.disabled = true;
                        option.textContent += (SCRIPT_CURRENT_LANG === 'ko' ? ' (API 키 필요)' : ' (API Key required)');
                    }
                    select.appendChild(option);
                });
                select.value = 'none'; 
            } catch (e) {
                console.error("Failed to load translators:", e);
            }
        }

        if (!SCRIPT_DISABLE_TRANSLATION) {
            const translatorTypeElement = document.getElementById('translator_type');
            if (translatorTypeElement) {
                translatorTypeElement.addEventListener('change', function() {
                    const targetLangElement = document.getElementById('target_lang');
                    if (targetLangElement) {
                        targetLangElement.disabled = (this.value === 'none');
                    }
                });
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            showStep(currentStep);
            loadTranslators();
            updateProgressText(0,0,0); // Initial progress text setup
        });

        conversionScopeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'multiple') {
                    selectorsSection.classList.remove('hidden');
                    contentSelectorInput.required = true;
                    menuSelectorInput.required = true;
                } else {
                    selectorsSection.classList.add('hidden');
                    contentSelectorInput.required = false;
                    menuSelectorInput.required = false;
                    const currentStepDiv = document.querySelector('.wizard-step[data-step="2"]');
                    if(currentStepDiv) {
                         [contentSelectorInput, menuSelectorInput].forEach(input => {
                            input.classList.remove('border-red-500');
                            const msgDiv = currentStepDiv.querySelector(`[data-validate-for="${input.name}"]`);
                            if(msgDiv) msgDiv.textContent = '';
                         });
                    }
                }
            });
        });
        
        const initialScope = document.querySelector('input[name="conversion_scope"]:checked').value;
        if (initialScope === 'multiple') {
            selectorsSection.classList.remove('hidden');
            contentSelectorInput.required = true;
            menuSelectorInput.required = true;
        } else {
            selectorsSection.classList.add('hidden');
            contentSelectorInput.required = false;
            menuSelectorInput.required = false;
        }
    </script>
</body>
</html>
