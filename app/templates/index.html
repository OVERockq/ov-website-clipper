<!DOCTYPE html>
<html lang="{{ current_lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{{ translations.meta_description }}">
    <meta name="keywords" content="{{ translations.meta_keywords }}">
    <title>{{ translations.title }}</title>
    {% if ad_client_id %}
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client={{ ad_client_id }}"
     crossorigin="anonymous"></script>
    {% endif %}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link rel="alternate" hreflang="ko" href="/?lang=ko" />
    <link rel="alternate" hreflang="en" href="/?lang=en" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#3B82F6', // Blue-500
                            hover: '#2563EB'  // Blue-600
                        },
                        secondary: {
                            DEFAULT: '#6B7280', // Gray-500
                            hover: '#4B5563'  // Gray-600
                        },
                        success: {
                            DEFAULT: '#10B981', // Emerald-500
                            hover: '#059669'  // Emerald-600
                        },
                        danger: {
                            DEFAULT: '#EF4444', // Red-500
                            hover: '#DC2626'  // Red-600
                        },
                        info: {
                            DEFAULT: '#3B82F6', // Blue-500 (Primary와 동일하게 사용 또는 다른 색상 지정)
                            hover: '#2563EB'
                        },
                        light: '#F9FAFB', // Gray-50
                        dark: '#1F2937'  // Gray-800
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* 좀 더 현대적인 폰트 (CDN 추가 필요 시 알려주세요) */
        }
        .step-indicator-line {
            height: 2px;
            flex-grow: 1;
            transition: background-color 0.3s ease-in-out;
        }
        .form-select, .form-input {
            @apply mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm;
        }
        /* 로딩 스피너를 위한 간단한 스타일 */
        .spinner {
            border-top-color: transparent;
            animation: spinner 0.8s linear infinite;
        }
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
        .lang-toggle-btn {
            transition: background 0.2s, color 0.2s;
        }
        .lang-switcher a {
            @apply px-3 py-1 text-sm rounded-md;
        }
        .lang-switcher a.active {
            @apply bg-primary text-white;
        }
        .lang-switcher a:not(.active) {
            @apply text-gray-600 hover:bg-gray-200;
        }
        /* Step Indicator: revert to simple Tailwind-based layout */
        /* (No custom .step-item or .step-item p styles) */
    </style>
</head>
<body class="bg-gray-100" data-translation-enabled="{{ 'true' if translation_enabled else 'false' }}">
    <div class="flex flex-col justify-center min-h-screen p-4">
        <!-- Main Content Area -->
        <div class="bg-white shadow-xl rounded-lg p-6 sm:p-10 w-full max-w-3xl mx-auto">
            <!-- Language Toggle (위쪽 오른쪽) -->
            <div class="flex justify-end items-center mb-2">
                <div class="inline-flex rounded-full bg-gray-100 p-1 shadow">
                    <a href="/?lang=ko" class="lang-toggle-btn px-4 py-1 rounded-full font-semibold transition {{ 'bg-primary text-white' if current_lang == 'ko' else 'text-gray-600 hover:bg-gray-200' }}">한국어</a>
                    <a href="/?lang=en" class="lang-toggle-btn px-4 py-1 rounded-full font-semibold transition {{ 'bg-primary text-white' if current_lang == 'en' else 'text-gray-600 hover:bg-gray-200' }}">English</a>
                </div>
            </div>            
            <header class="mb-8 sm:mb-10" style="margin-bottom: calc(2rem + 0.5em);">
                <div class="flex justify-between items-center mb-2">
                    <h1 class="text-3xl sm:text-4xl font-bold text-center text-dark flex-grow" style="margin-top:1.5em;">
                        <span class="text-primary">{{ translations.logo_text_part1 }}</span><span class="text-gray-600">{{ translations.logo_text_part2 }}</span> <i class="fas fa-wand-magic-sparkles text-primary"></i>
                    </h1>
                </div>
                <p class="text-center text-secondary text-sm sm:text-base">
                    {{ translations.header_subtitle }}
                </p>
            </header>
            
            <!-- Step Indicator -->
            <div class="flex items-center mb-2">
                <div class="step-item flex flex-col items-center flex-1" data-step="1">
                    <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center text-lg font-semibold z-10 bg-primary text-white border-2 border-primary transition-all duration-300">1</div>
                    <p class="mt-2 text-xs sm:text-sm font-medium text-primary text-center">{{ translations.step1_title }}</p>
                </div>
                <div class="step-indicator-line bg-gray-300 transition-all duration-300"></div>
                <div class="step-item flex flex-col items-center flex-1" data-step="2">
                    <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center text-lg font-semibold z-10 bg-gray-300 text-gray-600 border-2 border-gray-300 transition-all duration-300">2</div>
                    <p class="mt-2 text-xs sm:text-sm text-gray-500 text-center">{{ translations.step2_title }}</p>
                </div>
                <div class="step-indicator-line bg-gray-300 transition-all duration-300"></div>
                <div class="step-item flex flex-col items-center flex-1" data-step="3">
                    <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center text-lg font-semibold z-10 bg-gray-300 text-gray-600 border-2 border-gray-300 transition-all duration-300">3</div>
                    <p class="mt-2 text-xs sm:text-sm text-gray-500 text-center">{{ translations.step3_title }}</p>
                </div>
                <div class="step-indicator-line bg-gray-300 transition-all duration-300"></div>
                <div class="step-item flex flex-col items-center flex-1" data-step="4">
                    <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center text-lg font-semibold z-10 bg-gray-300 text-gray-600 border-2 border-gray-300 transition-all duration-300">4</div>
                    <p class="mt-2 text-xs sm:text-sm text-gray-500 text-center">{{ translations.step4_title }}</p>
                </div>
            </div>

            <div class="container mx-auto px-4 py-8">
                <div class="max-w-3xl mx-auto">
                    <div class="text-center mb-8">

                        <p class="mt-1">
                            {{ translations.footer_rate_limit_info.replace('{rate_limit_convert_per_minute}', rate_limit_convert_per_minute).replace('{rate_limit_per_hour}', rate_limit_per_hour).replace('{rate_limit_per_day}', rate_limit_per_day) }}
                        </p>
                    </div>

                    <!-- 에러 메시지 -->
                    <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden" role="alert">
                        <span class="block sm:inline"></span>
                    </div>

                    <!-- 성공 메시지 -->
                    <div id="success-message" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4 hidden" role="alert">
                        <span class="block sm:inline"></span>
                    </div>

                    <form id="conversion-form" enctype="multipart/form-data" class="space-y-6">
                        <!-- Step 1: URL 입력 -->
                        <div class="wizard-step active" data-step="1">
                            <h2 class="text-xl font-semibold text-dark mb-6">Step 1: {{ translations.step1_title }}</h2>
                            <div class="mb-6">
                                <label for="url" class="block text-sm font-medium text-gray-700 mb-1">{{ translations.url_input_label }}</label>
                                <input type="url" class="form-input w-full" id="url" name="url" placeholder="{{ translations.url_input_placeholder }}" required>
                                <p class="mt-1 text-xs text-gray-500">{{ translations.url_input_help }}</p>
                                <div class="text-red-500 text-xs mt-1" data-validate-for="url"></div>
                            </div>
                        </div>

                        <!-- Step 2: 선택자 입력 -->
                        <div class="wizard-step hidden" data-step="2">
                            <h2 class="text-xl font-semibold text-gray-700 mb-6">Step 2: {{ translations.step2_title }}</h2>
                            
                            <div class="mb-6">
                                <label class="block text-sm font-medium text-gray-700 mb-2">{{ translations.conversion_scope_label }}</label>
                                <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0">
                                    <label class="flex items-center p-3 border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer flex-1">
                                        <input type="radio" name="conversion_scope" value="single" class="form-radio h-5 w-5 text-primary focus:ring-primary-hover" checked>
                                        <span class="ml-3 text-sm font-medium text-gray-700">{{ translations.scope_single_page }}</span>
                                    </label>
                                    <label class="flex items-center p-3 border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer flex-1">
                                        <input type="radio" name="conversion_scope" value="multiple" class="form-radio h-5 w-5 text-primary focus:ring-primary-hover">
                                        <span class="ml-3 text-sm font-medium text-gray-700">{{ translations.scope_multiple_pages }}</span>
                                    </label>
                                </div>
                            </div>

                            <div id="selectors-section" class="hidden space-y-4 pt-4 border-t border-gray-200">
                                <p class="text-sm text-indigo-600 bg-indigo-50 p-3 rounded-md"><i class="fas fa-info-circle mr-2"></i>{{ translations.selectors_info }}</p>
                                <div class="mb-4">
                                    <label for="content_selector" class="block text-sm font-medium text-gray-700 mb-1">{{ translations.content_selector_label }}</label>
                                    <input type="text" class="form-input" id="content_selector" name="content_selector" placeholder="{{ translations.content_selector_placeholder }}">
                                    <p class="mt-1 text-xs text-gray-500">{{ translations.content_selector_help_intro }} <span class="text-indigo-500">{{ translations.content_selector_help_example | safe }}</span></p>
                                    <div class="text-red-500 text-xs mt-1" data-validate-for="content_selector"></div>
                                </div>
                                <div class="mb-4">
                                    <label for="menu_selector" class="block text-sm font-medium text-gray-700 mb-1">{{ translations.menu_selector_label }}</label>
                                    <input type="text" class="form-input" id="menu_selector" name="menu_selector" placeholder="{{ translations.menu_selector_placeholder }}">
                                    <p class="mt-1 text-xs text-gray-500">{{ translations.menu_selector_help_intro }} <span class="text-indigo-500">{{ translations.menu_selector_help_example | safe }}</span></p>
                                    <div class="text-red-500 text-xs mt-1" data-validate-for="menu_selector"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3: 포맷 및 번역 설정 -->
                        <div class="wizard-step hidden" data-step="3">
                            <h2 class="text-xl font-semibold text-gray-700 mb-6">Step 3: {{ translations.step3_title }}</h2>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-1">번역 여부 선택</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                                        <input type="radio" name="do_translate" id="do_translate_no" value="no" class="h-4 w-4 text-blue-600" checked>
                                        <span class="ml-3">아니오</span>
                                    </label>
                                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                                        <input type="radio" name="do_translate" id="do_translate_yes" value="yes" class="h-4 w-4 text-blue-600">
                                        <span class="ml-3">예</span>
                                    </label>
                                </div>
                            </div>
                            <div id="translation-options-section" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" style="display:none;">
                                <div>
                                    <label for="target_lang" class="block text-sm font-medium text-gray-700 mb-1">{{ translations.translation_language_label }}</label>
                                    <select class="form-select" id="target_lang" name="target_lang">
                                        <option value="ko">한국어</option>
                                        <option value="en">English</option>
                                        <option value="ja">日本語</option>
                                        <option value="zh">中文</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="translator_type" class="block text-sm font-medium text-gray-700 mb-1">{{ translations.translation_option_label }}</label>
                                    <select class="form-select" id="translator_type" name="translator_type">
                                        <option value="google">구글 번역 (내장)</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    {{ translations.output_format_label }}
                                </label>
                                <div class="grid grid-cols-4 gap-4">
                                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                                        <input type="radio" name="output_format" value="epub" class="h-4 w-4 text-blue-600" required>
                                        <span class="ml-3">EPUB</span>
                                    </label>
                                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                                        <input type="radio" name="output_format" value="pdf" class="h-4 w-4 text-blue-600" required>
                                        <span class="ml-3">PDF</span>
                                    </label>
                                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                                        <input type="radio" name="output_format" value="markdown" class="h-4 w-4 text-blue-600" required>
                                        <span class="ml-3">Markdown</span>
                                    </label>
                                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50">
                                        <input type="radio" name="output_format" value="doc" class="h-4 w-4 text-blue-600" required>
                                        <span class="ml-3">DOCX</span>
                                    </label>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4" id="merge-pages-section">
                                <div>
                                    <label for="merge_pages" class="block text-sm font-medium text-gray-700 mb-1">{{ translations.merge_pages_label }}</label>
                                    <select class="form-select" id="merge_pages" name="merge_pages">
                                        <option value="true">{{ translations.merge_pages_yes }}</option>
                                        <option value="false">{{ translations.merge_pages_no }}</option>
                                    </select>
                                    <p class="mt-1 text-xs text-gray-500">{{ translations.merge_pages_help }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Step 4: 변환 및 다운로드 -->
                        <div class="wizard-step hidden" data-step="4">
                            <h2 class="text-xl font-semibold text-gray-700 mb-6">{{ translations.confirm_and_convert_title }}</h2>
                            <div id="summary" class="bg-blue-50 p-4 rounded-md mb-6">
                                <p class="text-sm font-medium text-gray-700 mb-2">{{ translations.summary_title }}</p>
                                <ul id="summary-list" class="list-disc list-inside text-sm text-gray-600 space-y-1"></ul>
                            </div>
                            <p class="text-sm text-gray-600 mb-6">{{ translations.summary_help }}</p>
                            
                            <div id="loading-section" class="text-center py-6 hidden">
                                <div class="spinner w-12 h-12 rounded-full border-4 border-primary border-t-transparent mx-auto"></div>
                                <p class="text-gray-600 mt-3">{{ translations.loading_text }}</p>
                                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                                    <div id="progress-bar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                                <p id="progress-text" class="text-sm text-gray-500 mt-1">0% (0/0 {{ '페이지' if current_lang == 'ko' else 'pages'}})</p>
                            </div>

                            <div id="download-section" class="text-center py-6 hidden">
                                <i class="fas fa-check-circle text-5xl text-success mb-3"></i>
                                <h4 class="text-lg font-semibold text-gray-700">{{ translations.conversion_complete_title }}</h4>
                                <p class="text-sm text-gray-600 mt-1 mb-4">{{ translations.download_prompt }}</p>
                                <button type="button" id="download-btn" class="w-full sm:w-auto bg-success hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-md shadow-sm transition duration-150 ease-in-out">
                                    <i class="fas fa-download mr-2"></i> {{ translations.download_button }}
                                </button>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="mt-8 pt-6 border-t border-gray-200 flex justify-between items-center">
                            <button type="button" id="prevBtn" class="bg-secondary hover:bg-secondary-hover text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out hidden">
                                <i class="fas fa-arrow-left mr-2"></i> {{ translations.previous_button }}
                            </button>
                            <button type="button" id="nextBtn" class="bg-primary hover:bg-primary-hover text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out">
                                {{ translations.next_button }} <i class="fas fa-arrow-right ml-2"></i>
                            </button>
                            <button type="submit" id="submitBtn" class="bg-success hover:bg-success-hover text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out hidden">
                                <i class="fas fa-check mr-2"></i> {{ translations.submit_button }}
                            </button>
                        </div>
                    </form>
                    <div class="mt-10 pt-6 border-t border-gray-200">
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 rounded-md shadow" role="alert">
                            <div class="flex">
                                <div class="py-1"><i class="fas fa-exclamation-triangle fa-lg mr-3"></i></div>
                                <div>
                                    <p class="font-bold">{{ translations.copyright_notice_title }}</p>
                                    <p class="text-sm">
                                        {{ translations.copyright_notice_text }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <footer class="mt-8 text-center text-xs text-gray-500">
                        <p>{{ translations.footer_copyright | safe }}</p>
                    </footer>

                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_DISABLE_TRANSLATION = document.body.dataset.disableTranslation === 'True';
        const SCRIPT_CURRENT_LANG = "{{ current_lang }}";
        const TRANSLATIONS_JS = {{ translations | tojson | safe }};

        let currentStep = 1;
        const totalSteps = 4;
        let downloadUrl = null;
        let downloadFileName = null;

        const form = document.getElementById('conversion-form');
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const submitBtn = document.getElementById('submitBtn');
        
        const loadingSection = document.getElementById('loading-section');
        const downloadSection = document.getElementById('download-section');
        const downloadBtn = document.getElementById('download-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressTextElem = document.getElementById('progress-text'); // Renamed for clarity
        
        const errorMessageDiv = document.getElementById('error-message');
        const errorTextSpan = document.getElementById('error-text');
        const summaryList = document.getElementById('summary-list');

        const conversionScopeRadios = document.querySelectorAll('input[name="conversion_scope"]');
        const selectorsSection = document.getElementById('selectors-section');
        const contentSelectorInput = document.getElementById('content_selector');
        const menuSelectorInput = document.getElementById('menu_selector');

        const SCRIPT_TRANSLATION_ENABLED = document.body.dataset.translationEnabled === 'true';
        console.log('Initial Translation Status:', SCRIPT_TRANSLATION_ENABLED);  // 초기 상태 로그

        function updateStepIndicator() {
            document.querySelectorAll('.step-item').forEach((item, index) => {
                const step = parseInt(item.dataset.step);
                const circle = item.querySelector('.step-circle');
                const title = item.querySelector('p');
                const line = item.previousElementSibling && item.previousElementSibling.classList.contains('step-indicator-line') ? item.previousElementSibling : null;

                circle.classList.remove('bg-primary', 'text-white', 'border-primary', 'bg-gray-300', 'text-gray-600', 'border-gray-300', 'bg-success', 'border-success');
                title.classList.remove('text-primary', 'text-gray-500', 'font-medium', 'text-success');
                
                if (step < currentStep) { // Completed
                    circle.classList.add('bg-success', 'text-white', 'border-success');
                    title.classList.add('text-success', 'font-medium');
                    if(line) line.classList.remove('bg-gray-300');
                    if(line) line.classList.add('bg-success');
                } else if (step === currentStep) { // Active
                    circle.classList.add('bg-primary', 'text-white', 'border-primary');
                    title.classList.add('text-primary', 'font-medium');
                    if(line) line.classList.remove('bg-gray-300');
                    if(line) line.classList.add('bg-primary');
                } else { // Pending
                    circle.classList.add('bg-gray-300', 'text-gray-600', 'border-gray-300');
                    title.classList.add('text-gray-500');
                    if(line) line.classList.remove('bg-primary', 'bg-success');
                    if(line) line.classList.add('bg-gray-300');
                }
            });
        }

        function showStep(stepNumber) {
            // 모든 단계 숨기기
            document.querySelectorAll('.wizard-step').forEach(step => {
                step.classList.add('hidden');
            });
            
            // 현재 단계 표시
            const currentStepDiv = document.querySelector(`.wizard-step[data-step="${stepNumber}"]`);
            if (currentStepDiv) {
                currentStepDiv.classList.remove('hidden');
            }
            
            // 단계 표시기 업데이트
            updateStepIndicator();
            
            // 버튼 상태 업데이트
            prevBtn.classList.toggle('hidden', stepNumber === 1);
            nextBtn.classList.toggle('hidden', stepNumber === totalSteps);
            submitBtn.classList.toggle('hidden', stepNumber !== totalSteps);

            // 로딩 및 다운로드 섹션 숨기기
            loadingSection.classList.add('hidden');
            downloadSection.classList.add('hidden');
        }

        function validateStep(stepNumber) {
            const currentStepDiv = document.querySelector(`.wizard-step[data-step="${stepNumber}"]`);
            let isValid = true;
            
            // 모든 입력 필드의 유효성 검사 초기화
            currentStepDiv.querySelectorAll('input, select').forEach(input => {
                input.classList.remove('border-red-500');
                const validationMsgDiv = currentStepDiv.querySelector(`[data-validate-for="${input.name}"]`);
                if (validationMsgDiv) {
                    validationMsgDiv.textContent = '';
                }
            });

            // Step 1: URL 검증
            if (stepNumber === 1) {
                const urlInput = currentStepDiv.querySelector('input[name="url"]');
                if (!urlInput.value.trim()) {
                    urlInput.classList.add('border-red-500');
                    const validationMsgDiv = currentStepDiv.querySelector('[data-validate-for="url"]');
                    if (validationMsgDiv) {
                        validationMsgDiv.textContent = TRANSLATIONS_JS.validate_required;
                    }
                    isValid = false;
                } else if (!urlInput.value.match(/^(http|https):\/\//i)) {
                    urlInput.classList.add('border-red-500');
                    const validationMsgDiv = currentStepDiv.querySelector('[data-validate-for="url"]');
                    if (validationMsgDiv) {
                        validationMsgDiv.textContent = TRANSLATIONS_JS.validate_url;
                    }
                    isValid = false;
                }
            }
            
            // Step 2: 선택자 검증
            if (stepNumber === 2) {
                const conversionScope = document.querySelector('input[name="conversion_scope"]:checked').value;
                if (conversionScope === 'multiple') {
                    const contentSelector = currentStepDiv.querySelector('input[name="content_selector"]');
                    const menuSelector = currentStepDiv.querySelector('input[name="menu_selector"]');
                    
                    if (!contentSelector.value.trim()) {
                        contentSelector.classList.add('border-red-500');
                        const validationMsgDiv = currentStepDiv.querySelector('[data-validate-for="content_selector"]');
                        if (validationMsgDiv) {
                            validationMsgDiv.textContent = TRANSLATIONS_JS.validate_required;
                        }
                        isValid = false;
                    }
                    
                    if (!menuSelector.value.trim()) {
                        menuSelector.classList.add('border-red-500');
                        const validationMsgDiv = currentStepDiv.querySelector('[data-validate-for="menu_selector"]');
                        if (validationMsgDiv) {
                            validationMsgDiv.textContent = TRANSLATIONS_JS.validate_required;
                        }
                        isValid = false;
                    }
                }
            }
            
            // Step 3: 변환 옵션 검증
            if (stepNumber === 3) {
                const outputFormat = currentStepDiv.querySelector('input[name="output_format"]:checked');
                if (!outputFormat) {
                    const outputFormatSection = currentStepDiv.querySelector('#output-format-section');
                    if (outputFormatSection) {
                        outputFormatSection.classList.add('border-red-500');
                    }
                    isValid = false;
                }

                if (!SCRIPT_DISABLE_TRANSLATION) {
                    const translatorType = currentStepDiv.querySelector('select[name="translator_type"]');
                    const targetLang = currentStepDiv.querySelector('select[name="target_lang"]');
                    
                    if (translatorType && translatorType.hasAttribute('required') && !translatorType.value) {
                        translatorType.classList.add('border-red-500');
                        isValid = false;
                    }
                    
                    if (targetLang && targetLang.hasAttribute('required') && !targetLang.value) {
                        targetLang.classList.add('border-red-500');
                        isValid = false;
                    }
                }
            }

            return isValid;
        }

        function generateSummary() {
            summaryList.innerHTML = '';
            const formData = new FormData(form);
            
            // URL 정보
            const url = formData.get('url');
            addSummaryItem(TRANSLATIONS_JS.url_input_label, url);

            // 변환 범위
            const conversionScope = document.querySelector('input[name="conversion_scope"]:checked').value;
            const scopeText = conversionScope === 'single' ? 
                TRANSLATIONS_JS.scope_single_page : 
                TRANSLATIONS_JS.scope_multiple_pages;
            addSummaryItem(TRANSLATIONS_JS.step2_title, scopeText);

            // 선택자 정보 (multiple 모드일 경우)
            if (conversionScope === 'multiple') {
                const contentSelector = formData.get('content_selector');
                const menuSelector = formData.get('menu_selector');
                if (contentSelector) {
                    addSummaryItem(TRANSLATIONS_JS.content_selector_label, contentSelector);
                }
                if (menuSelector) {
                    addSummaryItem(TRANSLATIONS_JS.menu_selector_label, menuSelector);
                }
            }

            // 출력 형식
            const outputFormat = formData.get('output_format');
            addSummaryItem(TRANSLATIONS_JS.output_format_label, outputFormat ? outputFormat.toUpperCase() : '-');

            // 페이지 병합
            const mergePages = formData.get('merge_pages') === 'true';
            addSummaryItem(TRANSLATIONS_JS.merge_pages_label, 
                mergePages ? TRANSLATIONS_JS.merge_pages_yes : TRANSLATIONS_JS.merge_pages_no);

            // 번역 옵션
            if (!SCRIPT_DISABLE_TRANSLATION) {
                let translatorType = formData.get('translator_type');
                let targetLang = formData.get('target_lang');
                if (!translatorType || translatorType === 'none') {
                    addSummaryItem(TRANSLATIONS_JS.translation_option_label, '번역 안함');
                } else {
                    addSummaryItem(TRANSLATIONS_JS.translation_option_label, translatorType);
                    if (targetLang) {
                        addSummaryItem(TRANSLATIONS_JS.translation_language_label, targetLang);
                    }
                }
            }

            // 글꼴
            const fontFamily = formData.get('font_family');
            addSummaryItem(TRANSLATIONS_JS.font_family_label, fontFamily);
        }

        function addSummaryItem(label, value) {
            const listItem = document.createElement('li');
            listItem.className = 'mb-2';
            listItem.innerHTML = `<span class="font-medium text-gray-900">${label}:</span> ${value}`;
            summaryList.appendChild(listItem);
        }

        function updateProgressText(current, total, progress) {
            const progressText = document.getElementById('progress-text');
            if (progressText) {
                if (total === 0) {
                    progressText.textContent = SCRIPT_CURRENT_LANG === 'ko' ? '준비 중...' : 'Preparing...';
                } else {
                    progressText.textContent = `${progress}% (${current}/${total} ${SCRIPT_CURRENT_LANG === 'ko' ? '페이지' : 'pages'})`;
                }
            }
        }

        function showLoadingState() {
            loadingSection.classList.remove('hidden');
            downloadSection.classList.add('hidden');
            errorMessageDiv.classList.add('hidden');
            submitBtn.disabled = true;
            prevBtn.disabled = true;
            progressBar.style.width = '0%';
            updateProgressText(0, 0, 0);
        }

        function showDownloadState() {
            loadingSection.classList.add('hidden');
            downloadSection.classList.remove('hidden');
            submitBtn.disabled = false;
            prevBtn.disabled = false;
        }

        function showErrorState(errorMessage) {
            loadingSection.classList.add('hidden');
            downloadSection.classList.add('hidden');
            showError(errorMessage);
            submitBtn.disabled = false;
            prevBtn.disabled = false;
        }

        // 다음 버튼 이벤트 리스너
        nextBtn.addEventListener('click', () => {
            if (validateStep(currentStep)) {
                currentStep++;
                if (currentStep === totalSteps) {
                    generateSummary();
                }
                showStep(currentStep);
            }
        });

        // 이전 버튼 이벤트 리스너
        prevBtn.addEventListener('click', () => {
            currentStep--;
            showStep(currentStep);
        });

        // 폼 제출 이벤트 리스너
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!validateStep(currentStep)) return;

            // UI 상태 초기화
            downloadUrl = null;
            downloadFileName = null;
            showLoadingState();
            
            // 진행 상황 모니터링 시작
            const eventSource = connectToProgress();
            
            try {
                const formData = new FormData(form);
                const response = await fetch('/convert', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    downloadUrl = window.URL.createObjectURL(blob);
                    
                    const outputFormat = formData.get('output_format');
                    const mergePages = formData.get('merge_pages') === 'true';
                    const menuSelector = formData.get('menu_selector');

                    let extension = outputFormat;
                    if (outputFormat === 'markdown' && !mergePages && menuSelector) {
                        extension = 'zip';
                    }
                    downloadFileName = `converted_document.${extension}`;
                    
                    showDownloadState();
                } else {
                    let errorMsg = '변환 중 오류가 발생했습니다.';
                    try {
                        const errorData = await response.json();
                        errorMsg = errorData.error || errorMsg;
                    } catch {
                        // JSON 파싱 실패 시 기본 메시지 사용
                    }
                    showErrorState(errorMsg);
                }
            } catch (error) {
                showErrorState(error.message || '네트워크 오류가 발생했습니다.');
            } finally {
                eventSource.close();
            }
        });

        // 다운로드 버튼 이벤트 리스너
        downloadBtn.addEventListener('click', () => {
            if (downloadUrl && downloadFileName) {
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = downloadFileName;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(downloadUrl);
                document.body.removeChild(a);
            }
        });

        function loadTranslators() {
            console.log('loadTranslators function called');  // 함수 호출 확인
            
            const translationOptions = document.getElementById('translation-options');
            const translatorSelect = document.getElementById('translator_type');
            const targetLangSelect = document.getElementById('target_lang');
            
            console.log('Translation Elements:', {  // 요소 존재 여부 확인
                translationOptions: !!translationOptions,
                translatorSelect: !!translatorSelect,
                targetLangSelect: !!targetLangSelect
            });
            
            // 번역이 활성화된 경우에만 번역 옵션 표시
            if (SCRIPT_TRANSLATION_ENABLED) {
                console.log('Translation is enabled');  // 활성화 상태 확인
                if (translationOptions) {
                    translationOptions.style.display = 'grid';
                    console.log('Translation options displayed');
                }
                
                // 번역기 목록 추가
                if (translatorSelect) {
                    translatorSelect.innerHTML = '<option value="none">번역 안함</option>';
                    translatorSelect.innerHTML += '<option value="google">구글 번역 (내장)</option>';
                    console.log('Translation options added to select');
                }
                
                // 번역기 선택 이벤트 핸들러
                if (translatorSelect && targetLangSelect) {
                    translatorSelect.onchange = function() {
                        console.log('Translator type changed to:', this.value);  // 선택 변경 확인
                        if (this.value === 'none') {
                            targetLangSelect.disabled = true;
                            targetLangSelect.removeAttribute('required');
                            console.log('Target language select disabled');
                        } else {
                            targetLangSelect.disabled = false;
                            targetLangSelect.setAttribute('required', '');
                            console.log('Target language select enabled');
                        }
                    };
                }
            } else {
                console.log('Translation is disabled');  // 비활성화 상태 확인
                if (translationOptions) {
                    translationOptions.style.display = 'none';
                    console.log('Translation options hidden');
                }
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }

        function updateProgress(progress) {
            if (progress.error) {
                showErrorState(progress.error);
                return;
            }
            
            if (progress.completed) {
                progressBar.style.width = '100%';
                updateProgressText(progress.current, progress.total, 100);
                showSuccess('변환이 완료되었습니다. 다운로드가 시작됩니다.');
                return;
            }
            
            progressBar.style.width = `${progress.progress}%`;
            updateProgressText(progress.current, progress.total, progress.progress);
        }

        function connectToProgress() {
            const eventSource = new EventSource('/progress');
            
            eventSource.onmessage = function(event) {
                const progress = JSON.parse(event.data);
                updateProgress(progress);
                
                if (progress.completed || progress.error) {
                    eventSource.close();
                }
            };
            
            eventSource.onerror = function() {
                eventSource.close();
                showErrorState('진행 상황 업데이트 연결이 끊어졌습니다.');
            };
            
            return eventSource;
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded');  // 페이지 로드 확인
            showStep(currentStep);
            loadTranslators();
            updateProgressText(0, 0, 0);

            // 변환 범위 변경 이벤트 리스너
            conversionScopeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'multiple') {
                        selectorsSection.classList.remove('hidden');
                        contentSelectorInput.required = true;
                        menuSelectorInput.required = true;
                    } else {
                        selectorsSection.classList.add('hidden');
                        contentSelectorInput.required = false;
                        menuSelectorInput.required = false;
                        const currentStepDiv = document.querySelector('.wizard-step[data-step="2"]');
                        if(currentStepDiv) {
                            [contentSelectorInput, menuSelectorInput].forEach(input => {
                                input.classList.remove('border-red-500');
                                const msgDiv = currentStepDiv.querySelector(`[data-validate-for="${input.name}"]`);
                                if(msgDiv) msgDiv.textContent = '';
                            });
                        }
                    }
                });
            });
            
            // 초기 변환 범위 설정
            const initialScope = document.querySelector('input[name="conversion_scope"]:checked').value;
            if (initialScope === 'multiple') {
                selectorsSection.classList.remove('hidden');
                contentSelectorInput.required = true;
                menuSelectorInput.required = true;
            } else {
                selectorsSection.classList.add('hidden');
                contentSelectorInput.required = false;
                menuSelectorInput.required = false;
            }

            const mergePagesSection = document.getElementById('merge-pages-section');
            function updateMergePagesVisibility() {
                const conversionScope = document.querySelector('input[name="conversion_scope"]:checked').value;
                if (conversionScope === 'multiple') {
                    mergePagesSection.style.display = '';
                } else {
                    mergePagesSection.style.display = 'none';
                }
            }
            conversionScopeRadios.forEach(radio => {
                radio.addEventListener('change', updateMergePagesVisibility);
            });
            updateMergePagesVisibility();

            // 번역 여부에 따라 옵션/출력형식 제어
            const doTranslateYes = document.getElementById('do_translate_yes');
            const doTranslateNo = document.getElementById('do_translate_no');
            const translationOptionsSection = document.getElementById('translation-options-section');
            const outputFormatRadios = document.querySelectorAll('input[name="output_format"]');
            const translatorTypeSelect = document.getElementById('translator_type');
            const targetLangSelect = document.getElementById('target_lang');

            function updateTranslationUI() {
                if (doTranslateYes.checked) {
                    translationOptionsSection.style.display = '';
                    if (translatorTypeSelect) {
                        translatorTypeSelect.value = 'google';
                        translatorTypeSelect.removeAttribute('disabled');
                        translatorTypeSelect.setAttribute('readonly', 'readonly');
                    }
                    if (outputFormatRadios) {
                        outputFormatRadios.forEach(radio => {
                            if (radio.value === 'markdown') {
                                radio.checked = true;
                            }
                            radio.setAttribute('readonly', 'readonly');
                        });
                    }
                    if (targetLangSelect) {
                        targetLangSelect.disabled = false;
                    }
                } else {
                    translationOptionsSection.style.display = 'none';
                    if (translatorTypeSelect) {
                        translatorTypeSelect.value = 'none';
                        translatorTypeSelect.removeAttribute('readonly');
                        translatorTypeSelect.removeAttribute('disabled');
                    }
                    if (outputFormatRadios) {
                        outputFormatRadios.forEach(radio => {
                            radio.removeAttribute('readonly');
                        });
                    }
                    if (targetLangSelect) {
                        targetLangSelect.disabled = true;
                    }
                }
            }
            if (doTranslateYes && doTranslateNo) {
                doTranslateYes.addEventListener('change', updateTranslationUI);
                doTranslateNo.addEventListener('change', updateTranslationUI);
                updateTranslationUI();
            }

            // 글꼴 선택 컨테이너 표시/숨김 처리
            function updateFontFamilyVisibility() {
                const outputFormat = document.querySelector('input[name="output_format"]:checked')?.value;
                const fontFamilyContainer = document.getElementById('fontFamilyContainer');
                
                if (outputFormat === 'pdf' || outputFormat === 'doc') {
                    fontFamilyContainer.classList.remove('hidden');
                } else {
                    fontFamilyContainer.classList.add('hidden');
                }
            }

            // 출력 형식 변경 시 글꼴 선택 표시/숨김 업데이트
            document.querySelectorAll('input[name="output_format"]').forEach(radio => {
                radio.addEventListener('change', updateFontFamilyVisibility);
            });

            // 변환 시작 버튼 클릭 시
            document.getElementById('startConversion').addEventListener('click', function() {
                // 이전 버튼과 변환 시작 버튼 숨기기
                document.getElementById('prevStep3').classList.add('hidden');
                document.getElementById('startConversion').classList.add('hidden');
                // 변환 중지 버튼 표시
                document.getElementById('stopConversion').classList.remove('hidden');
                
                // 변환 시작
                startConversion();
            });

            // 변환 중지 버튼 클릭 시
            document.getElementById('stopConversion').addEventListener('click', function() {
                if (confirm('{{ translations.stop_conversion_confirm }}')) {
                    // 변환 중지 요청
                    fetch('/stop_conversion', { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // 변환 중지 버튼 숨기고 변환 시작 버튼 표시
                                document.getElementById('stopConversion').classList.add('hidden');
                                document.getElementById('startConversion').classList.remove('hidden');
                                document.getElementById('prevStep3').classList.remove('hidden');
                            }
                        });
                }
            });

            // 처음으로 버튼 클릭 시
            document.getElementById('goToStart').addEventListener('click', function() {
                // Step 1로 이동
                showStep(1);
                // 모든 입력 필드 초기화
                document.getElementById('conversionForm').reset();
                // 글꼴 선택 컨테이너 초기화
                updateFontFamilyVisibility();
            });

            // 변환 완료 시 호출되는 함수
            function onConversionComplete() {
                // 변환 중지 버튼 숨기고 처음으로 버튼 표시
                document.getElementById('stopConversion').classList.add('hidden');
                document.getElementById('goToStart').classList.remove('hidden');
            }
        });

        function startConversion() {
            const formData = new FormData(document.getElementById('conversionForm'));
            
            // 진행 상태 표시
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingText').textContent = '{{ translations.loading_text }}';
            
            fetch('/convert', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                // 다운로드 링크 생성
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = formData.get('title') || 'converted_file';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // 변환 완료 처리
                onConversionComplete();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('{{ translations.error_prefix }} ' + error.message);
                // 오류 발생 시 버튼 상태 복구
                document.getElementById('stopConversion').classList.add('hidden');
                document.getElementById('startConversion').classList.remove('hidden');
                document.getElementById('prevStep3').classList.remove('hidden');
            })
            .finally(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
            });
        }
    </script>
</body>
</html>
