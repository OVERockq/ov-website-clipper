<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="웹페이지를 EPUB, Markdown, DOCX, PDF 등 다양한 형식으로 손쉽게 변환하세요. 여러 페이지 병합, 번역 기능도 지원합니다.">
    <meta name="keywords" content="웹페이지 변환, ebook 변환, HTML 변환, EPUB, Markdown, DOCX, PDF, 온라인 변환기, 웹 콘텐츠 저장">
    <title>웹페이지 변환 마법사 - EPUB, PDF, Markdown 변환</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-YOUR_PUBLISHER_ID"
     crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#3B82F6', // Blue-500
                            hover: '#2563EB'  // Blue-600
                        },
                        secondary: {
                            DEFAULT: '#6B7280', // Gray-500
                            hover: '#4B5563'  // Gray-600
                        },
                        success: {
                            DEFAULT: '#10B981', // Emerald-500
                            hover: '#059669'  // Emerald-600
                        },
                        danger: {
                            DEFAULT: '#EF4444', // Red-500
                            hover: '#DC2626'  // Red-600
                        },
                        info: {
                            DEFAULT: '#3B82F6', // Blue-500 (Primary와 동일하게 사용 또는 다른 색상 지정)
                            hover: '#2563EB'
                        },
                        light: '#F9FAFB', // Gray-50
                        dark: '#1F2937'  // Gray-800
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* 좀 더 현대적인 폰트 (CDN 추가 필요 시 알려주세요) */
        }
        .step-indicator-line {
            height: 2px;
            flex-grow: 1;
            transition: background-color 0.3s ease-in-out;
        }
        .form-select, .form-input {
            @apply mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary sm:text-sm;
        }
        /* 로딩 스피너를 위한 간단한 스타일 */
        .spinner {
            border-top-color: transparent;
            animation: spinner 0.8s linear infinite;
        }
        @keyframes spinner {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100" data-disable-translation="{{ disable_translation }}">
    <div class="flex flex-col md:flex-row justify-center min-h-screen p-4 gap-4">
        <!-- Main Content Area -->
        <div class="bg-white shadow-xl rounded-lg p-6 sm:p-10 w-full md:max-w-3xl order-2 md:order-1">
            <header class="mb-8 sm:mb-10">
                <h1 class="text-3xl sm:text-4xl font-bold text-center text-dark mb-2">
                웹페이지 변환 마법사 <i class="fas fa-wand-magic-sparkles text-primary"></i>
            </h1>
            <p class="text-center text-secondary text-sm sm:text-base">
                원하는 웹페이지를 손쉽게 EPUB, PDF, Markdown 등 다양한 파일로 변환하세요!
            </p>
        </header>
        
        <!-- Step Indicator -->
        <div class="flex items-center mb-10">
            <div class="step-item flex-1 flex flex-col items-center" data-step="1">
                <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center text-lg font-semibold z-10 bg-primary text-white border-2 border-primary transition-all duration-300">1</div>
                <p class="mt-2 text-xs sm:text-sm font-medium text-primary transition-all duration-300">URL 입력</p>
            </div>
            <div class="step-indicator-line bg-gray-300 transition-all duration-300"></div>
            <div class="step-item flex-1 flex flex-col items-center" data-step="2">
                <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center text-lg font-semibold z-10 bg-gray-300 text-gray-600 border-2 border-gray-300 transition-all duration-300">2</div>
                <p class="mt-2 text-xs sm:text-sm text-gray-500 transition-all duration-300">변환 영역 선택</p>
            </div>
            <div class="step-indicator-line bg-gray-300 transition-all duration-300"></div>
            <div class="step-item flex-1 flex flex-col items-center" data-step="3">
                <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center text-lg font-semibold z-10 bg-gray-300 text-gray-600 border-2 border-gray-300 transition-all duration-300">3</div>
                <p class="mt-2 text-xs sm:text-sm text-gray-500 transition-all duration-300">변환 옵션</p>
            </div>
            <div class="step-indicator-line bg-gray-300 transition-all duration-300"></div>
            <div class="step-item flex-1 flex flex-col items-center" data-step="4">
                <div class="step-circle w-10 h-10 rounded-full flex items-center justify-center text-lg font-semibold z-10 bg-gray-300 text-gray-600 border-2 border-gray-300 transition-all duration-300">4</div>
                <p class="mt-2 text-xs sm:text-sm text-gray-500 transition-all duration-300">완료</p>
            </div>
        </div>

        <form id="convertForm" enctype="multipart/form-data" class="space-y-6">
            <!-- Step 1: URL 입력 -->
            <div class="wizard-step active" data-step="1">
                <h2 class="text-xl font-semibold text-dark mb-6">Step 1: 변환할 웹페이지 URL</h2>
                <div class="mb-4">
                    <label for="url" class="block text-sm font-medium text-gray-700 mb-1">웹페이지 URL</label>
                    <input type="url" class="form-input" id="url" name="url" placeholder="https://example.com" required>
                    <p class="mt-1 text-xs text-gray-500">변환하고 싶은 웹페이지의 전체 URL을 입력해주세요.</p>
                    <div class="text-red-500 text-xs mt-1" data-validate-for="url"></div>
                </div>
            </div>

            <!-- Step 2: 선택자 입력 -->
            <div class="wizard-step hidden" data-step="2">
                <h2 class="text-xl font-semibold text-gray-700 mb-6">Step 2: 변환 영역 선택</h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">웹페이지에서 변환할 영역을 어떻게 선택하시겠어요?</label>
                    <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-2 sm:space-y-0">
                        <label class="flex items-center p-3 border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer flex-1">
                            <input type="radio" name="conversion_scope" value="single" class="form-radio h-5 w-5 text-primary focus:ring-primary-hover" checked>
                            <span class="ml-3 text-sm font-medium text-gray-700">단일 페이지 (자동인식/읽기모드)</span>
                        </label>
                        <label class="flex items-center p-3 border border-gray-300 rounded-md hover:bg-gray-50 cursor-pointer flex-1">
                            <input type="radio" name="conversion_scope" value="multiple" class="form-radio h-5 w-5 text-primary focus:ring-primary-hover">
                            <span class="ml-3 text-sm font-medium text-gray-700">여러 페이지 (직접 선택자 입력)</span>
                        </label>
                    </div>
                </div>

                <div id="selectors-section" class="hidden space-y-4 pt-4 border-t border-gray-200">
                    <p class="text-sm text-indigo-600 bg-indigo-50 p-3 rounded-md"><i class="fas fa-info-circle mr-2"></i>여러 페이지 변환 시 아래 선택자를 정확히 입력해주세요.</p>
                    <div class="mb-4">
                        <label for="content_selector" class="block text-sm font-medium text-gray-700 mb-1">본문 선택자</label>
                        <input type="text" class="form-input" id="content_selector" name="content_selector" placeholder="예: main, #content, //div[@class='article-body']">
                        <p class="mt-1 text-xs text-gray-500">각 페이지에서 실제 내용이 담긴 영역입니다. CSS 선택자 또는 XPath. <span class="text-indigo-500">예: <code>main</code>, <code>.article-content</code></span></p>
                        <div class="text-red-500 text-xs mt-1" data-validate-for="content_selector"></div>
                    </div>
                    <div class="mb-4">
                        <label for="menu_selector" class="block text-sm font-medium text-gray-700 mb-1">메뉴 선택자</label>
                        <input type="text" class="form-input" id="menu_selector" name="menu_selector" placeholder="예: nav, .sidebar ul, //div[@class='table-of-contents']">
                        <p class="mt-1 text-xs text-gray-500">여러 페이지 링크가 포함된 메뉴 영역입니다. CSS 선택자 또는 XPath. <span class="text-indigo-500">예: <code>nav ul.menu</code>, <code>#toc</code></span></p>
                        <div class="text-red-500 text-xs mt-1" data-validate-for="menu_selector"></div>
                    </div>
                </div>
            </div>

            <!-- Step 3: 포맷 및 번역 설정 -->
            <div class="wizard-step hidden" data-step="3">
                <h2 class="text-xl font-semibold text-gray-700 mb-6">Step 3: 변환 옵션 설정</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="output_format" class="block text-sm font-medium text-gray-700 mb-1">출력 형식</label>
                        <select class="form-select" id="output_format" name="output_format" required>
                    <option value="epub">EPUB</option>
                    <option value="markdown">Markdown</option>
                            <option value="doc">Word (DOCX)</option>
                    <option value="pdf">PDF</option>
                </select>
            </div>
                    <div>
                        <label for="merge_pages" class="block text-sm font-medium text-gray-700 mb-1">페이지 병합</label>
                        <select class="form-select" id="merge_pages" name="merge_pages">
                            <option value="true">하나의 문서로 병합</option>
                            <option value="false">개별 문서로 생성</option>
                </select>
                         <p class="mt-1 text-xs text-gray-500">Markdown 개별 생성 시 ZIP으로 제공됩니다.</p>
                    </div>
            </div>
                {% if not disable_translation %}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="translator_type" class="block text-sm font-medium text-gray-700 mb-1">번역 옵션</label>
                        <select class="form-select" id="translator_type" name="translator_type" required>
                    <option value="none" selected>번역하지 않음</option>
                            <!-- JS로 동적 로드 -->
                </select>
            </div>
                    <div>
                        <label for="target_lang" class="block text-sm font-medium text-gray-700 mb-1">번역 언어</label>
                        <select class="form-select" id="target_lang" name="target_lang" disabled>
                    <option value="ko">한국어</option>
                    <option value="en">영어</option>
                    <option value="ja">일본어</option>
                    <option value="zh">중국어</option>
                </select>
                    </div>
            </div>
                {% endif %}
                 <div class="mb-4">
                    <label for="font_family" class="block text-sm font-medium text-gray-700 mb-1">글꼴 (PDF/DOCX 용)</label>
                    <select class="form-select" id="font_family" name="font_family">
                    <option value="Noto Sans KR" selected>Noto Sans KR</option>
                    <option value="Nanum Gothic">나눔고딕</option>
                    <option value="Malgun Gothic">맑은고딕</option>
                        <option value="Apple SD Gothic Neo">Apple SD Gothic Neo</option>
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                </select>
                </div>
            </div>

            <!-- Step 4: 변환 및 다운로드 -->
            <div class="wizard-step hidden" data-step="4">
                <h2 class="text-xl font-semibold text-gray-700 mb-6">Step 4: 확인 및 변환</h2>
                <div id="summary" class="bg-blue-50 p-4 rounded-md mb-6">
                    <p class="text-sm font-medium text-gray-700 mb-2">입력 정보 요약:</p>
                    <ul id="summary-list" class="list-disc list-inside text-sm text-gray-600 space-y-1"></ul>
                </div>
                <p class="text-sm text-gray-600 mb-6">정보가 정확한지 확인 후 "변환 시작" 버튼을 눌러주세요.</p>
                
                <div id="loading-section" class="text-center py-6 hidden">
                    <div class="spinner w-12 h-12 rounded-full border-4 border-primary border-t-transparent mx-auto"></div>
                    <p class="text-gray-600 mt-3">변환 중입니다. 잠시 기다려주세요...</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                        <div id="progress-bar" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="progress-text" class="text-sm text-gray-500 mt-1">0% (0/0 페이지)</p>
                </div>

                <div id="download-section" class="text-center py-6 hidden">
                    <i class="fas fa-check-circle text-5xl text-success mb-3"></i>
                    <h4 class="text-lg font-semibold text-gray-700">변환이 완료되었습니다!</h4>
                    <p class="text-sm text-gray-600 mt-1 mb-4">아래 버튼으로 다운로드하세요.</p>
                    <button type="button" id="download-btn" class="w-full sm:w-auto bg-success hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-md shadow-sm transition duration-150 ease-in-out">
                        <i class="fas fa-download mr-2"></i> 다운로드
                    </button>
                </div>
                 <div id="error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative hidden" role="alert">
                    <strong class="font-bold">오류:</strong>
                    <span class="block sm:inline" id="error-text"></span>
                 </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="mt-8 pt-6 border-t border-gray-200 flex justify-between items-center">
                <button type="button" id="prevBtn" class="bg-secondary hover:bg-secondary-hover text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out hidden">
                    <i class="fas fa-arrow-left mr-2"></i> 이전
                </button>
                <button type="button" id="nextBtn" class="bg-primary hover:bg-primary-hover text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out">
                    다음 <i class="fas fa-arrow-right ml-2"></i>
                </button>
                <button type="submit" id="submitBtn" class="bg-success hover:bg-success-hover text-white font-semibold py-2.5 px-6 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out hidden">
                    <i class="fas fa-check mr-2"></i> 변환 시작
                </button>
            </div>
        </form>

        <div class="mt-10 pt-6 border-t border-gray-200">
            <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-700 p-4 rounded-md shadow" role="alert">
                <div class="flex">
                    <div class="py-1"><i class="fas fa-exclamation-triangle fa-lg mr-3"></i></div>
                    <div>
                        <p class="font-bold">저작권 유의사항</p>
                        <p class="text-sm">
                            본 서비스를 통해 변환된 콘텐츠의 저작권은 원저작자에게 있습니다.
                            사용자는 개인적인 학습 및 연구 목적으로만 변환된 콘텐츠를 사용해야 하며,
                            저작권법을 위반하는 방식으로 사용하거나 무단으로 배포, 공유, 상업적으로 이용해서는 안 됩니다.
                            본 서비스는 사용자가 제공한 URL의 웹 콘텐츠를 기술적으로 변환하는 도구이며,
                            콘텐츠의 내용이나 저작권에 대한 책임을 지지 않습니다.
                            서비스 이용으로 인해 발생하는 모든 법적 책임은 사용자 본인에게 있습니다.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="adsense-container mt-10 text-center text-xs text-gray-400">
            <!-- 여기에 애드센스 광고 코드를 삽입하세요. 예: -->
            <!-- 
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-YOUR_PUBLISHER_ID"
                 data-ad-slot="YOUR_AD_SLOT_ID"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
            -->
            {% if ad_client_id_bottom and ad_slot_id_bottom %}
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="{{ ad_client_id_bottom }}"
                 data-ad-slot="{{ ad_slot_id_bottom }}"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
            {% else %}
            <p>하단 광고가 표시될 영역입니다.</p>
            {% endif %}
        </div>
    </div>

    <!-- Right Sidebar Ad Area -->
    <div class="w-full md:w-64 order-1 md:order-2 flex-shrink-0">
        <div class="bg-white shadow-xl rounded-lg p-4 sticky top-4">
            <h3 class="text-lg font-semibold text-gray-700 mb-3 text-center">광고</h3>
            <div class="adsense-right-container text-center text-xs text-gray-400">
                <!-- 여기에 오른쪽 애드센스 광고 코드를 삽입하세요. 예: -->
                <!--
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="{{ ad_client_id_right }}"
                     data-ad-slot="{{ ad_slot_id_right }}"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
                <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
                -->
                 {% if ad_client_id_right and ad_slot_id_right %}
                <ins class="adsbygoogle"
                     style="display:block;min-width:120px;max-width:240px;width:100%;height:600px;"
                     data-ad-client="{{ ad_client_id_right }}"
                     data-ad-slot="{{ ad_slot_id_right }}"></ins>
                <script>
                     (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
                {% else %}
                <p>오른쪽 광고 영역</p>
                <p class="text-xs text-gray-400">(160x600 또는 유사 크기 권장)</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

    <script>
        const SCRIPT_DISABLE_TRANSLATION = document.body.dataset.disableTranslation === 'True';
        let currentStep = 1;
        const totalSteps = 4;
        let downloadUrl = null;
        let downloadFileName = null;

        const form = document.getElementById('convertForm');
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const submitBtn = document.getElementById('submitBtn');
        
        const loadingSection = document.getElementById('loading-section');
        const downloadSection = document.getElementById('download-section');
        const downloadBtn = document.getElementById('download-btn');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        
        const errorMessageDiv = document.getElementById('error-message');
        const errorTextSpan = document.getElementById('error-text');
        const summaryList = document.getElementById('summary-list');

        // Step 2: 라디오 버튼 및 선택자 섹션 DOM 요소
        const conversionScopeRadios = document.querySelectorAll('input[name="conversion_scope"]');
        const selectorsSection = document.getElementById('selectors-section');
        const contentSelectorInput = document.getElementById('content_selector');
        const menuSelectorInput = document.getElementById('menu_selector');

        function updateStepIndicator() {
            document.querySelectorAll('.step-item').forEach((item, index) => {
                const step = parseInt(item.dataset.step);
                const circle = item.querySelector('.step-circle');
                const title = item.querySelector('p');
                const line = item.previousElementSibling && item.previousElementSibling.classList.contains('step-indicator-line') ? item.previousElementSibling : null;

                circle.classList.remove('bg-primary', 'text-white', 'border-primary', 'bg-gray-300', 'text-gray-600', 'border-gray-300', 'bg-success', 'border-success');
                title.classList.remove('text-primary', 'text-gray-500', 'font-medium', 'text-success');
                
                if (step < currentStep) { // Completed
                    circle.classList.add('bg-success', 'text-white', 'border-success');
                    title.classList.add('text-success', 'font-medium');
                    if(line) line.classList.remove('bg-gray-300');
                    if(line) line.classList.add('bg-success');
                } else if (step === currentStep) { // Active
                    circle.classList.add('bg-primary', 'text-white', 'border-primary');
                    title.classList.add('text-primary', 'font-medium');
                    if(line) line.classList.remove('bg-gray-300');
                    if(line) line.classList.add('bg-primary');
                } else { // Pending
                    circle.classList.add('bg-gray-300', 'text-gray-600', 'border-gray-300');
                    title.classList.add('text-gray-500');
                    if(line) line.classList.remove('bg-primary', 'bg-success');
                    if(line) line.classList.add('bg-gray-300');
                }
            });
        }

        function showStep(stepNumber) {
            document.querySelectorAll('.wizard-step').forEach(step => step.classList.add('hidden'));
            document.querySelector(`.wizard-step[data-step="${stepNumber}"]`).classList.remove('hidden');
            updateStepIndicator();

            prevBtn.classList.toggle('hidden', stepNumber === 1);
            nextBtn.classList.toggle('hidden', stepNumber === totalSteps);
            submitBtn.classList.toggle('hidden', stepNumber !== totalSteps);
        }

        function validateStep(stepNumber) {
            const currentStepDiv = document.querySelector(`.wizard-step[data-step="${stepNumber}"]`);
            const inputs = currentStepDiv.querySelectorAll('input[required], select[required]');
            let isValid = true;
            
            inputs.forEach(input => {
                const validationMsgDiv = currentStepDiv.querySelector(`[data-validate-for="${input.name}"]`);
                // 현재 스텝이 2이고, 해당 input이 selectors-section 내에 있으며, selectors-section이 숨겨져 있다면 유효성 검사 건너뛰기
                if (stepNumber === 2 && selectorsSection.classList.contains('hidden') && input.closest('#selectors-section')) {
                    input.classList.remove('border-red-500');
                    if(validationMsgDiv) validationMsgDiv.textContent = '';
                    return; // 다음 input으로 넘어감
                }

                if (!input.value.trim() && input.required) { // .required 조건 추가
                    input.classList.add('border-red-500');
                    if(validationMsgDiv) validationMsgDiv.textContent = '이 필드는 필수입니다.';
                    isValid = false;
                } else if (input.type === 'url' && !input.value.match(/^(http|https)?:\/\//i)) {
                    input.classList.add('border-red-500');
                     if(validationMsgDiv) validationMsgDiv.textContent = '유효한 URL을 입력해주세요 (예: http:// 또는 https://).';
                    isValid = false;
                }
                 else {
                    input.classList.remove('border-red-500');
                    if(validationMsgDiv) validationMsgDiv.textContent = '';
                }
            });
            return isValid;
        }
        
        function generateSummary() {
            summaryList.innerHTML = ''; 
            const formData = new FormData(form);
            const summaryData = {
                "URL": formData.get("url"),
                "변환 영역": document.querySelector('input[name="conversion_scope"]:checked').parentElement.textContent.trim(),
                "출력 형식": formData.get("output_format").toUpperCase(),
                "페이지 병합": formData.get("merge_pages") === "true" ? "예" : "아니오",
                "글꼴": document.getElementById('font_family').selectedOptions[0].text
            };

            if (!SCRIPT_DISABLE_TRANSLATION) {
                summaryData["번역 옵션"] = document.getElementById('translator_type').selectedOptions[0].text;
                summaryData["번역 언어"] = formData.get("translator_type") !== "none" ? document.getElementById('target_lang').selectedOptions[0].text : "해당 없음";
            }

            // "여러 페이지" 선택 시에만 선택자 정보 추가
            if (formData.get("conversion_scope") === "multiple") {
                summaryData["본문 선택자"] = formData.get("content_selector");
                summaryData["메뉴 선택자"] = formData.get("menu_selector") || "입력 안함";
            }

            for (const [key, value] of Object.entries(summaryData)) {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<span class="font-medium text-gray-900">${key}:</span> ${value}`;
                summaryList.appendChild(listItem);
            }
        }

        nextBtn.addEventListener('click', () => {
            if (validateStep(currentStep)) {
                currentStep++;
                if (currentStep === totalSteps) {
                    generateSummary();
                }
                showStep(currentStep);
            }
        });

        prevBtn.addEventListener('click', () => {
            currentStep--;
            showStep(currentStep);
        });

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!validateStep(currentStep)) return;

            // 이전 다운로드 상태 초기화
            downloadUrl = null;
            downloadFileName = null;
            downloadSection.classList.add('hidden');
            // 기존 downloadFileHandler가 downloadBtn에 연결되어 있다면,
            // 새 변환 시에는 이 버튼 자체가 아니라, 성공 시 새로 생성되는 URL을 사용하므로
            // 특정 핸들러를 제거할 필요는 없을 수 있습니다. downloadUrl이 null이면 어차피 동작 안 함.
            // 하지만 명확성을 위해, 버튼 클릭 시 항상 최신 downloadUrl을 참조하도록 합니다.

            loadingSection.classList.remove('hidden');
            errorMessageDiv.classList.add('hidden');
            submitBtn.disabled = true;
            prevBtn.disabled = true;
            
            progressBar.style.width = '0%';
            progressText.textContent = '0% (0/0 페이지)';
            
            try {
                const formData = new FormData(form);
                const response = await fetch('/convert', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const blob = await response.blob();
                    downloadUrl = window.URL.createObjectURL(blob);
                    
                    const outputFormat = formData.get('output_format');
                    const mergePages = formData.get('merge_pages') === 'true';
                    const menuSelector = formData.get('menu_selector');

                    let extension = outputFormat;
                    if (outputFormat === 'markdown' && !mergePages && menuSelector ) {
                         extension = 'zip';
                    }
                    downloadFileName = `converted_document.${extension}`;
                    
                    loadingSection.classList.add('hidden');
                    downloadSection.classList.remove('hidden');
                } else {
                    const error = await response.text();
                    errorTextSpan.textContent = error;
                    errorMessageDiv.classList.remove('hidden');
                    loadingSection.classList.add('hidden');
                }
            } catch (error) {
                errorTextSpan.textContent = '네트워크 또는 알 수 없는 오류: ' + error.message;
                errorMessageDiv.classList.remove('hidden');
                loadingSection.classList.add('hidden');
            } finally {
                submitBtn.disabled = false;
                prevBtn.disabled = false;
            }
        });
        
        // 다운로드 버튼 클릭 핸들러
        function downloadFileHandler() {
            if (downloadUrl && downloadFileName) {
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = downloadFileName;
                document.body.appendChild(a);
                a.click();
                // Blob URL은 다운로드 후 명시적으로 해제해주는 것이 좋습니다.
                // 다운로드가 시작된 후 약간의 시간차를 두고 해제하거나,
                // 사용자가 페이지를 벗어날 때 해제하는 방법도 고려할 수 있습니다.
                // 여기서는 클릭 후 바로 해제합니다. 대부분의 경우 문제없이 동작합니다.
                window.URL.revokeObjectURL(downloadUrl); 
                a.remove();
                
                // 다운로드 후 상태 초기화 (선택적)
                // downloadUrl = null;
                // downloadFileName = null;
                // downloadSection.classList.add('hidden');
            }
        }
        // 페이지 로드 시 다운로드 버튼에 이벤트 리스너 한 번만 할당
        downloadBtn.addEventListener('click', downloadFileHandler);

        const eventSource = new EventSource('/progress');
        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            progressBar.style.width = `${data.progress}%`;
            progressText.textContent = `${data.progress}% (${data.current_page}/${data.total_pages} 페이지)`;
        };
        eventSource.onerror = function(err) {
            console.error("EventSource failed:", err);
        };

        async function loadTranslators() {
            if (SCRIPT_DISABLE_TRANSLATION) {
                // 번역 비활성화 시 번역 옵션 및 언어 선택 UI를 숨기거나 비활성화 처리
                const translatorTypeDiv = document.getElementById('translator_type')?.closest('.grid > div');
                const targetLangDiv = document.getElementById('target_lang')?.closest('.grid > div');
                if (translatorTypeDiv) translatorTypeDiv.style.display = 'none';
                if (targetLangDiv) targetLangDiv.style.display = 'none';
                return;
            }
            try {
            const res = await fetch('/api/available_translators');
                if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            const translators = await res.json();
            const select = document.getElementById('translator_type');
            select.innerHTML = '';
                
            const noneOpt = document.createElement('option');
            noneOpt.value = 'none';
            noneOpt.textContent = '번역하지 않음';
            select.appendChild(noneOpt);

            translators.forEach(opt => {
                    if (opt.value === 'none' && opt.label.includes('비활성화됨')) { // "번역하지 않음 (비활성화됨)" 옵션은 추가하지 않음
                        return;
                    }
                    if (opt.value === 'none') return; 
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    if (opt.disabled) { 
                        option.disabled = true;
                        option.textContent += ' (API 키 필요)';
                    }
                    select.appendChild(option);
                });
                select.value = 'none'; 
            } catch (e) {
                console.error("번역기 목록 로딩 실패:", e);
                }
        }

        if (!SCRIPT_DISABLE_TRANSLATION) {
            const translatorTypeElement = document.getElementById('translator_type');
            if (translatorTypeElement) {
                translatorTypeElement.addEventListener('change', function() {
                    const targetLangElement = document.getElementById('target_lang');
                    if (targetLangElement) {
                        targetLangElement.disabled = (this.value === 'none');
                    }
                });
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            showStep(currentStep);
            loadTranslators();
        });

        // Step 2 라디오 버튼 변경 감지
        conversionScopeRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'multiple') {
                    selectorsSection.classList.remove('hidden');
                    contentSelectorInput.required = true;
                    menuSelectorInput.required = true; // 여러 페이지 선택 시 메뉴 선택자도 필수로 설정
                } else {
                    selectorsSection.classList.add('hidden');
                    contentSelectorInput.required = false;
                    menuSelectorInput.required = false;
                    // 선택적: 단일 페이지 선택 시 기존 값 초기화
                    // contentSelectorInput.value = ''; 
                    // menuSelectorInput.value = '';
                    // 에러 메시지도 초기화
                    currentStepDiv = document.querySelector('.wizard-step[data-step="2"]');
                    if(currentStepDiv) {
                         [contentSelectorInput, menuSelectorInput].forEach(input => {
                            input.classList.remove('border-red-500');
                            const msgDiv = currentStepDiv.querySelector(`[data-validate-for="${input.name}"]`);
                            if(msgDiv) msgDiv.textContent = '';
                         });
                    }
                }
            });
        });
        // 초기 로드 시 라디오 버튼 상태에 따라 섹션 표시 결정 (checked된 옵션 기준)
        const initialScope = document.querySelector('input[name="conversion_scope"]:checked').value;
        if (initialScope === 'multiple') {
            selectorsSection.classList.remove('hidden');
            contentSelectorInput.required = true;
            menuSelectorInput.required = true;
        } else {
            selectorsSection.classList.add('hidden');
            contentSelectorInput.required = false;
            menuSelectorInput.required = false;
        }
    </script>
</body>
</html>
